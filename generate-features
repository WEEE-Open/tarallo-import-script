#!/usr/bin/php
<?php
chdir(__DIR__);
$data = file_get_contents('tarallo-backend' . DIRECTORY_SEPARATOR . 'database-data.sql');
$lines = preg_split('/[\n\r]/', $data, -1, PREG_SPLIT_NO_EMPTY);
//$resultjs = "\t// BEGIN GENERATED CODE" . PHP_EOL;
$resultphp = "\t// BEGIN GENERATED CODE" . PHP_EOL . "\tconst features = [" . PHP_EOL;
$resultphp2 = "\tconst groups = [" . PHP_EOL;
$resultlocalized = "\t// BEGIN GENERATED CODE" . PHP_EOL . "\tconst features = [" . PHP_EOL;
$resultlocalized2 = '';

$block = 0;
$features = [];
echo 'Found ' . count($lines) . ' lines' . PHP_EOL;
foreach($lines as $line) {
	/** @noinspection SqlNoDataSourceInspection */
	$wut = 'INSERT INTO `Feature`';
	if(substr($line, 0, strlen($wut)) === $wut) {
		$block = 1;
		continue;
	}
	/** @noinspection SqlNoDataSourceInspection */
	$wut = 'INSERT INTO `FeatureEnum`';
	if(substr($line, 0, strlen($wut)) === $wut) {
		$block = 2;
		continue;
	}
	/** @noinspection SqlNoDataSourceInspection */
	$wut = 'INSERT INTO `Prefixes`';
	if(substr($line, 0, strlen($wut)) === $wut) {
		$block = 3;
		continue;
	}
	if($block === 0 || $block === 3) {
		continue;
	} else {
		$boom = explode(',', $line);
		if(count($boom) < 2) {
			continue;
		}
		if(substr(trim($boom[0]), 0, 2) == '--') {
			continue;
		}
		if($block === 1) {
			$feature = $id = substr($boom[0], 3, strlen($boom[0]) - 4);
			$group = substr($boom[1], 2, strlen($boom[1]) - 3);
			$type = substr($boom[2], 1, 1);

			$features[$id] = [];

			switch($type) {
				case '0':
					//$resultjs .= "\tfeatureTypes.set('$feature', 's');" . PHP_EOL;
					$resultphp .= "\t\t'$feature' => self::STRING," . PHP_EOL;
					break;
				case '1':
					//$resultjs .= "\tfeatureTypes.set('$feature', 'i');" . PHP_EOL;
					$resultphp .= "\t\t'$feature' => self::INTEGER," . PHP_EOL;
					break;
				case '2':
					//$resultjs .= "\tfeatureTypes.set('$feature', 'e');" . PHP_EOL;
					//$resultjs .= "\tfeatureValues.set('$feature', {REPLACE$id});" . PHP_EOL;
					//$resultjs .= "\tfeatureValuesTranslated.set('$feature', {REPLACETRANSLATED$id});" . PHP_EOL;
					$resultphp .= "\t\t'$feature' => [{REPLACE$id}]," . PHP_EOL;
					break;
				case '3':
					//$resultjs .= "\tfeatureTypes.set('$feature', 'd');" . PHP_EOL;
					$resultphp .= "\t\t'$feature' => self::DOUBLE," . PHP_EOL;
					break;
			}
			$resultphp2 .= "\t\t'$feature' => self::GROUP_$group," . PHP_EOL;

			// Last piece has less fragments since it ends with ; instead of ,
			$thePiece = isset($boom[3]) ? $boom[3]: $boom[2];
			$translationPieces = explode('--', $thePiece);
			if(count($translationPieces) >= 2) {
				$translation = trim($translationPieces[1]);
			} else {
				echo "Missing translation for $feature\n";
				exit(1);
			}

			$resultlocalized .= "\t\t'$feature' => '$translation'," . PHP_EOL;

			echo "Feature: $group->$feature:$type:$translation" . PHP_EOL;
		} else if($block === 2) {
			$id = substr($boom[0], 3, strlen($boom[0]) - 4);

			if(count($boom) === 2) {
				// Last piece
				$value = explode(';', $boom[1])[0];
				$value = substr($value, 2, strlen($value) - 4);
			} else {
				$value = substr($boom[1], 2, strlen($boom[1]) - 4);
			}

			$features[$id][] = $value;

			$thePiece = isset($boom[2]) ? $boom[2] : $boom[1];
			$translationPieces = explode('--', $thePiece);
			if(count($translationPieces) >= 2) {
				$translation = trim($translationPieces[1]);
			} else {
				echo "Missing translation for $id=$value\n";
				exit(1);
			}

			$resultlocalized2 .= "\t\t'$id' => [{REPLACE$id}]," . PHP_EOL;
			$featuresTranslated[$id][$value] = $translation;

			echo "Value: $id:$value:$translation" . PHP_EOL;
		} else {
			echo 'Lolwut?' . PHP_EOL;
		}
	}
}
unset($id);
unset($type);
unset($block);
unset($thePiece);
unset($value);
unset($translation);
unset($translationPieces);

foreach($features as $id => $values) {
	//$arrayjs = '[';
	$arrayphp = '';
	foreach($values as $value) {
		//$arrayjs .= '\'' . $value . '\', ';
		$arrayphp .= "'$value' => true, ";
	}
	//$arrayjs = substr($arrayjs, 0, strlen($arrayjs) - 2);
	$arrayphp = substr($arrayphp, 0, strlen($arrayphp) - 2); // trailing commas are valid in PHP, but this looks nicer
	//$arrayjs .= ']';
	//$resultjs = str_replace('{REPLACE' . $id . '}', $arrayjs, $resultjs);
	$resultphp = str_replace('{REPLACE' . $id . '}', $arrayphp, $resultphp);
}
assert(isset($featuresTranslated));
foreach($featuresTranslated as $id => $values) {
	$arrayphp = '';
	//$arrayjs = '[';
	//foreach($values as $value) {
		//$arrayjs .= '\'' . $value . '\', ';
	//}
	//$arrayjs = substr($arrayjs, 0, strlen($arrayjs) - 2);
	//$arrayjs .= ']';
	//$resultjs = str_replace('{REPLACETRANSLATED' . $id . '}', $arrayjs, $resultjs);
	foreach($values as $value => $translated) {
		$arrayphp .= "'$value' => '$translated', ";
	}
	$arrayphp = substr($arrayphp, 0, strlen($arrayphp) - 2);
	$resultlocalized2 = str_replace('{REPLACE' . $id . '}', $arrayphp, $resultlocalized2);
}
$resultlocalized2 = implode(PHP_EOL,array_unique(explode(PHP_EOL, $resultlocalized2)));

//$resultjs .= "\t// END GENERATED CODE";
$resultphp .= "\t];" . PHP_EOL . $resultphp2;
$resultphp .= "\t];" . PHP_EOL . "\t// END GENERATED CODE";

$resultlocalized .= "\t];" . PHP_EOL;
$resultlocalized2 .= "\t];" . PHP_EOL . "\t// END GENERATED CODE";
$resultlocalized = implode("\tconst featuresEnum = [\n", [$resultlocalized, $resultlocalized2]);
unset($resultlocalized2);

// Safer alternative:
//file_put_contents('features.generated.js', $resultjs);
//echo 'Done. Run "cat features.generated.js >> tarallo-frontend/js/features.js" and manually merge the file'.PHP_EOL;

//$file = 'tarallo-backend' . DIRECTORY_SEPARATOR . 'SSRv1' . DIRECTORY_SEPARATOR . 'static' . DIRECTORY_SEPARATOR . 'features.js';
//$js = file_get_contents($file);
//
//$piecesjs = explode("\t// BEGIN GENERATED CODE" . PHP_EOL, $js, 2);
//if(count($piecesjs) < 2) {
//	echo "Cannot find // BEGIN GENERATED CODE (indented and followed by a newline in current platform format, which may be the problem) in $file" . PHP_EOL;
//	exit(1);
//}
//
//$piecesjs2 = explode("\t// END GENERATED CODE", $js, 2);
//if(count($piecesjs2) < 2) {
//	echo "Cannot find // END GENERATED CODE in $file" . PHP_EOL;
//	exit(1);
//}

$php = file_get_contents('tarallo-backend' . DIRECTORY_SEPARATOR . 'src' . DIRECTORY_SEPARATOR . 'Feature.php');

$piecesphp = explode("\t// BEGIN GENERATED CODE" . PHP_EOL, $php, 2);
if(count($piecesphp) < 2) {
	echo 'Cannot find // BEGIN GENERATED CODE (indented and followed by a newline in current platform format, which may be the problem) in tarallo-backend/src/Feature.php' . PHP_EOL;
	exit(1);
}

$piecesphp2 = explode("\t// END GENERATED CODE", $php, 2);
if(count($piecesphp2) < 2) {
	echo 'Cannot find indented // END GENERATED CODE in tarallo-backend/src/Feature.php' . PHP_EOL;
	exit(1);
}

$localized = file_get_contents('tarallo-backend' . DIRECTORY_SEPARATOR . 'SSRv1' . DIRECTORY_SEPARATOR . 'FeaturePrinter.php');

$pieceslocalized = explode("\t// BEGIN GENERATED CODE" . PHP_EOL, $localized, 2);
if(count($pieceslocalized) < 2) {
	echo 'Cannot find // BEGIN GENERATED CODE (indented and followed by a newline in current platform format, which may be the problem) in tarallo-backend/SSRv1/FeaturePrinter.php' . PHP_EOL;
	exit(1);
}

$pieceslocalized2 = explode("\t// END GENERATED CODE", $localized, 2);
if(count($pieceslocalized2) < 2) {
	echo 'Cannot find indented // END GENERATED CODE in tarallo-backend/SSRv1/FeaturePrinter.php' . PHP_EOL;
	exit(1);
}

//file_put_contents($file, $piecesjs[0] . $resultjs . $piecesjs2[1]);
file_put_contents('tarallo-backend' . DIRECTORY_SEPARATOR . 'src' . DIRECTORY_SEPARATOR . 'Feature.php',
	$piecesphp[0] . $resultphp . $piecesphp2[1]);
file_put_contents('tarallo-backend' . DIRECTORY_SEPARATOR . 'SSRv1' . DIRECTORY_SEPARATOR . 'FeaturePrinter.php',
	$pieceslocalized[0] . $resultlocalized . $pieceslocalized2[1]);
echo "Done. Check 'tarallo-backend/src/Feature.php', 'tarallo-backend/SSRv1/FeaturePrinter.php' and commit changes" . PHP_EOL;
